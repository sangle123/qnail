jQuery(function($) {
  var DSM_CardCarousel = $(".dsm_card_carousel");
  if (DSM_CardCarousel.length) {
    $(".dsm_card_carousel_wrapper").each(function() {
      //Check it before initialization
      $(".dsm_card_carousel_child").each(function() {
        if (
          $(this)
            .find(".et_pb_module_inner")
            .children().length === 0
        )
          $(this)
            .find(".et_pb_module_inner")
            .parent()
            .remove();
      });
      $(document).on("click", ".dsm-card-lightbox-trigger", function(e) {
        e.preventDefault();
        var items_src, type, classes;

        if ($(this).hasClass("dsm-card-image-lightbox")) {
          items_src = $(this)
            .parent()
            .attr("data-mfp-src");
          type = "image";
          classes = "";
        } else {
          items_src = $(this)
            .parent()
            .attr("data-mfp-src");
          type = "iframe";
          classes = "dsm-video-popup-wrap ";
        }
        if ($(this).hasClass("et_pb_button")) {
          items_src = $(this).attr("href");
        }

        $.magnificPopup.open({
          delegate: "a",
          items: {
            src: items_src,
          },
          type: type,
          iframe: {
            markup:
              '<div class="mfp-iframe-scaler dsm-video-popup">' +
              '<div class="mfp-close"></div>' +
              '<iframe class="mfp-iframe" frameborder="0" allowfullscreen></iframe>' +
              "</div>",
            patterns: {
              youtube: {
                index: "youtube.com/",
                id: "v=",
                src: "//www.youtube.com/embed/%id%?autoplay=1&rel=0",
              },
              youtu_be: {
                index: "youtu.be",
                id: "/",
                src: "//www.youtube.com/embed/%id%?autoplay=1&rel=0",
              },
              vimeo: {
                index: "vimeo.com/",
                id: "/",
                src: "//player.vimeo.com/video/%id%?autoplay=1",
              },
              dailymotion: {
                index: "dailymotion.com",
                id: function(url) {
                  var m = url.match(
                    /^.+dailymotion.com\/(video|hub)\/([^_]+)[^#]*(#video=([^_&]+))?/
                  );
                  if (m !== null) {
                    if (m[4] !== undefined) {
                      return m[4];
                    }
                    return m[2];
                  }
                  return null;
                },
                src: "https://www.dailymotion.com/embed/video/%id%",
              },
            },
            srcAction: "iframe_src",
          },
          removalDelay: 500,
          mainClass: classes + "mfp-fade",
        });
      });
      /*			remove for future since observer is set to true 
            var carouselInPopup = '';
            if ($(this).closest(".dsm-popup").length || $(this).closest(".et_pb_tabs").length) {
                carouselInPopup = true;
            } else {
                carouselInPopup = false
            }
            */

      var params = JSON.parse($(this).attr("data-params"));
      var DSM_CardSwiper = new Swiper(this, {
        resizeObserver: true,
        observer: true,
        observeParents: true,
        observeSlideChildren: true,
        direction: params[0]["direction"],
        effect: params[0]["effect"],
        coverflowEffect: {
          slideShadows: params[0]["slider_effect_shadows"],
          rotate: params[0]["slider_effect_coverflow_rotate"],
          depth: params[0]["slider_effect_coverflow_depth"],
        },
        flipEffect: {
          rotate: 30,
          slideShadows: params[0]["slider_effect_shadows"],
        },
        cubeEffect: {
          slideShadows: params[0]["slider_effect_shadows"],
          shadow: params[0]["slider_effect_shadows"],
          shadowOffset: 20,
          shadowScale: 0.94,
        },
        centeredSlides: params[0]["centered_slides"],
        speed: parseInt(params[0]["speed"], 10),
        loop: params[0]["loop"],
        pagination: {
          el: $(this).siblings(".swiper-pagination")[0],
          type: "bullets",
          clickable: true,
        },
        navigation: {
          nextEl: $(this).siblings(".swiper-button-next")[0],
          prevEl: $(this).siblings(".swiper-button-prev")[0],
        },
        mousewheel: params[0]["mousewheel"],
        autoplay: {
          //enabled: params[0]['autoplay'],
          enabled: false,
          delay: parseInt(params[0]["autoplay_speed"], 10),
          disableOnInteraction: false,
        },
        grabCursor:
          false === params[0]["touch_move"] ? false : params[0]["grab"],
        preloadImages: false,
        lazy: {
          loadPrevNext: true,
        },
        allowTouchMove: params[0]["touch_move"],

        /*
                slidesPerView: 'cube' === params[0]['effect'] || 'flip' === params[0]['effect'] ? 1 : parseInt(params[0]['slide_to_show'], 10),
                slidesPerGroup: parseInt(params[0]['slide_to_scroll'], 10),
                spaceBetween: parseInt(params[0]['space_between'], 10),
                */
        breakpoints: {
          981: {
            slidesPerView:
              "cube" === params[0]["effect"] || "flip" === params[0]["effect"]
                ? 1
                : parseInt(params[0]["slide_to_show"], 10),
            slidesPerGroup: parseInt(params[0]["slide_to_scroll"], 10),
            spaceBetween: parseInt(params[0]["space_between"], 10),
            slidesPerColumn: params[0]["slide_row"],
            slidesPerColumnFill: "row",
            autoHeight: params[0]["auto_height"],
          },
          768: {
            slidesPerView:
              "cube" === params[0]["effect"] || "flip" === params[0]["effect"]
                ? 1
                : parseInt(params[0]["slide_to_show_tablet"], 10),
            slidesPerGroup: parseInt(params[0]["slide_to_scroll_tablet"], 10),
            spaceBetween: parseInt(params[0]["space_between_tablet"], 10),
            slidesPerColumn: params[0]["slide_row_tablet"],
            slidesPerColumnFill: "row",
            autoHeight: params[0]["equal_height_tablet"],
          },
          480: {
            slidesPerView:
              "cube" === params[0]["effect"] || "flip" === params[0]["effect"]
                ? 1
                : parseInt(params[0]["slide_to_show_phone"], 10),
            slidesPerGroup: parseInt(params[0]["slide_to_scroll_phone"], 10),
            spaceBetween: parseInt(params[0]["space_between_phone"], 10),
            slidesPerColumn: params[0]["slide_row_phone"],
            slidesPerColumnFill: "row",
            autoHeight: params[0]["equal_height_phone"],
          },
          320: {
            slidesPerView:
              "cube" === params[0]["effect"] || "flip" === params[0]["effect"]
                ? 1
                : parseInt(params[0]["slide_to_show_phone"], 10),
            slidesPerGroup: parseInt(params[0]["slide_to_scroll_phone"], 10),
            spaceBetween: parseInt(params[0]["space_between_phone"], 10),
            slidesPerColumn: params[0]["slide_row_phone"],
            slidesPerColumnFill: "row",
            autoHeight: params[0]["equal_height_phone"],
          },
        },
      });

      if (params[0]["pause_on_hover"] === true) {
        $(this).on("mouseenter", function(e) {
          DSM_CardSwiper.autoplay.stop();
        });
        $(this).on("mouseleave", function(e) {
          DSM_CardSwiper.autoplay.start();
        });
      }
      if ($(this).closest(".et_pb_tabs").length) {
        $(".et_pb_tabs a").on("click", function() {
          DSM_CardSwiper.slideTo(DSM_CardSwiper.realIndex, 0);
        });
      }
      if ($(this).closest(".dsm_advanced_tabs").length) {
        $(".dsm-tab").on("click", function() {
          DSM_CardSwiper.slideTo(DSM_CardSwiper.realIndex, 0);
        });
      }
      if (params[0]["autoplay"] === true) {
        if (typeof Waypoint === "undefined") {
          DSM_CardSwiper.autoplay.start();
        } else {
          var waypoint = new Waypoint({
            element: $(this),
            handler: function(direction) {
              DSM_CardSwiper.autoplay.start();
              this.destroy();
            },
            offset: params[0]["autoplay_viewport"],
          });
        }
      }
      DSM_CardSwiper.on("slideChange", function() {
        $(DSM_CardSwiper.slides).each(function(i, e) {
          if ($(this).hasClass("et_clickable")) {
            if (
              "undefined" !== typeof et_link_options_data &&
              true < et_link_options_data.length
            ) {
              $(et_link_options_data).each(function(i, e) {
                var child_item = "dsm_card_carousel_child_" + i;
                if (e.class && e.url && e.target) {
                  var clickClass = "." + e.class;
                  var clickURL = e.url;
                  var clickTarget = e.target;
                  $(clickClass)
                    .unbind()
                    .click(function() {
                      window.open(clickURL, clickTarget);
                    });
                }
              });
            }
          }
        });
      });

      $(window).on("resize", function() {
        //var ww = $(window).width();
        if (DSM_CardSwiper !== null) {
          //DSM_CardSwiper.updateAutoHeight(parseInt(params[0]['speed'], 10));
          DSM_CardSwiper.updateSize();
          DSM_CardSwiper.update();
        }
      });
    });
  }
});
